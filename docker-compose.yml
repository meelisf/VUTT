services:
  # Backend: Python serverid (File Server + Image Server)
  backend:
    build: .
    container_name: vutt-backend
    restart: always
    environment:
      - VUTT_DATA_DIR=/data
      - MEILISEARCH_URL=http://meilisearch:7700
      - MEILISEARCH_MASTER_KEY=${MEILI_MASTER_KEY:-vutt_master_key}
    volumes:
      # Mountime andmed hostilt konteinerisse
      - ./data:/data
      # Mountime olekufailid (kasutajad, tokenid jms)
      - ./state:/app/state
    # Pordid suletud välismaailmale (ainult sisevõrk või nginx kasutab)
    # Avame localhostile host Nginxi jaoks
    ports:
      - "127.0.0.1:8001:8001"
      - "127.0.0.1:8002:8002"

  # Otsingumootor
  meilisearch:
    image: getmeili/meilisearch:v1
    container_name: vutt-meili
    restart: always
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-vutt_master_key}
      - MEILI_NO_ANALYTICS=true
    volumes:
      - meili_data:/meili_data
    # Avame localhostile host Nginxi jaoks
    ports:
      - "127.0.0.1:7700:7700"

  # Umami Analytics Database
  db-umami:
    image: postgres:15-alpine
    container_name: vutt-umami-db
    restart: always
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: ${UMAMI_DB_PASSWORD:-vutt_umami_db_pass}
    volumes:
      - umami_db_data:/var/lib/postgresql/data

  # Umami Analytics App
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    container_name: vutt-umami
    restart: always
    environment:
      DATABASE_URL: postgresql://umami:${UMAMI_DB_PASSWORD:-vutt_umami_db_pass}@db-umami:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: ${UMAMI_APP_SECRET:-vutt_umami_secret_key_change_me}
      BASE_PATH: /analytics
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      - db-umami

  # Frontend ja Reverse Proxy (Host Nginx tegeleb sellega nüüd)
  # nginx:
  #   image: nginx:alpine
  #   container_name: vutt-nginx
  #   restart: always
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./dist:/usr/share/nginx/html:ro
  #   depends_on:
  #     - backend
  #     - meilisearch

volumes:
  meili_data:
  umami_db_data:

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.201.0/24